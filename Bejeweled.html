<html>
<head>
	<style>
		*{padding: 0; margin:0;}
		canvas{ background: #F5F5F5; display: block; margin: 0 auto;}
	</style>
</head>
<body>
<canvas id= "myCanvas" width="800" height= "600"></canvas>
<script type="text/javascript">
						//Dis is da code!!
var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");
document.addEventListener("mousemove",mouseMoveHandler,false);
document.addEventListener("mousedown",getPosition,false);
document.addEventListener("mouseup",getPosition2,false);
var timeX = 460;
var randNum3 = 0;
var randStringNum = "";
var color = "";
var counter = 0;
var counter2 = 0;
var pX = 0;
var pY = 0;
var mouseIsDown = false;
var score = 0;
var checkForZeroes = false;
var fallingCols = [];

function mouseMoveHandler(e) {
    pX = e.clientX - canvas.offsetLeft;
    pY = e.clientY - canvas.offsetTop;
}

function getPosition2(event){
	mouseIsDown = false;
}

function getPosition(event)
{
	mouseIsDown = true;
}

function getRandomInt(min, max) {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function gridObject(x, y, isSelected, value, isEmpty)
{
	this.x = x;
	this.y = y;
	this.isSelected = isSelected;
	this.value = value;
	this.isEmpty = isEmpty;
}

function fallingCol(startX, startY, data)
{
	this.x = startX;
	this.y = startY;
	this.nums = data;
	this.stopIt = (60 * data.length) / 5;
	this.startIt = 0;
}



var randNums = [];
for(var i = 0;i< 8; i++)
{
	randNums[i] = [];
	for(var j = 0;j< 8; j++)
	{
		var v = getRandomInt(1, 3);
		var x = (345+ (j*60));
		var y = (40 + (i*60));
		randNums[i][j] = new gridObject(x, y, false, v, false);
	}
}

function randArray()
{
	for(var i =0;i<8;i++)
	{
		for(var j = 0;j<8;j++)
		{
			var x = (345+ (j*60));
			var y = (40 + (i*60));
			ctx.fillStyle = "#000000";
			ctx.font = "30px Times New Roman";
			ctx.fillText(randNums[i][j].value, x, y);
		}
	}
}



function drawGrid()
{
	for(var i =0;i<8;i++)
	{
		for(var j = 0;j<8;j++)
		{
			if(randNums[i][j].isSelected)
			{
				ctx.fillStyle = "rgb(255,255,255)";
				ctx.fillRect((310 + (j*60)),(10 + (i*60)),60,60);
			}
			ctx.strokeStyle = "rgb(0,0,0)"
			ctx.rect((310 + (j*60)),(10 + (i*60)),60,60);
			ctx.stroke();
			//ctx.strokeStyle = "rgb(255,255,255)"
		}
	}
}

function collision()
{
	for(var i =0;i<8;i++)
	{
		for(var j = 0;j<8;j++)
		{
			///ctx.rect((310 + (j*60)),(10 + (i*60)),(60),(60));
			if(pX > (310 + (j*60)) && pX < ((310 + (j*60))+60) &&
			pY > (10 + (i*60)) && pY < ((10 + (i*60))+60))
			{
				if(mouseIsDown)
				{
					randNums[i][j].isSelected = true;
				}
			}
		}
	}
}

function checkForMatches()
{
	
	for(var i =0; i < 3; i++)
	{
		for(var j = 0; j < 3; j++)
		{
			if(randNums[i][j].value == randNums[i+1][j].value &&
			randNums[i][j].value == randNums[i+2][j].value &&
			randNums[i][j].value == randNums[i+3][j].value &&
			randNums[i][j].value == randNums[i+4][j].value&&
			randNums[i][j].value > 0)
			{
				//we have a match of 5 across
				console.log("We have a 5 match down");
				console.log("Starting at i  j: " + i + "   " + j);
				score += 30;
				randNums[i][j].value = 0;
				randNums[i+1][j].value = 0;
				randNums[i+2][j].value = 0;
				randNums[i+3][j].value = 0;
				randNums[i+4][j].value = 0;
				i = 4;
				j = 4;
			}
			
			else if(randNums[i][j].value == randNums[i][j+1].value &&
			randNums[i][j].value == randNums[i][j+2].value &&
			randNums[i][j].value == randNums[i][j+3].value &&
			randNums[i][j].value == randNums[i][j+4].value &&
			randNums[i][j].value > 0)
			{
				//we have a match of 5 across
				console.log("We have a 5 match across");
				console.log("Starting at i  j: " + i + "   " + j);
				score += 30;
				randNums[i][j].value = 0;
				randNums[i][j+1].value = 0;
				randNums[i][j+2].value = 0;
				randNums[i][j+3].value = 0;
				randNums[i][j+4].value = 0;
				checkForZeroes = true;
				i = 4;
				j = 4;
			}
		}
	}
	
}

function checkingForZeroes()
{
	for(var i =7; i >= 0; i--)
	{
		for(var j = 7; j >= 0; j--)
		{
			if(randNums[i][j].value == 0)
			{
				console.log("randnums[i][j] == 0");
				var count = 0;
				var tempI = i;
				console.log("Temp i is: " + tempI);
				while(tempI >= 0)
				{
					if(randNums[tempI][j].value == 0)
					{
						console.log("Temp i is: " + tempI);
						count++;
						tempI--;
					}
				}
				
				var tempNums = [];
				var indexToStartAdding = i - count;
				while(indexToStartAdding >= 0)
				{
					tempNums[tempNums.length] = randNums[indexToStartAdding][j];
					indexToStartAdding--;
				}
				while(count > 0)
				{
					tempNums[tempNums.length] = getRandomInt(1, 3);
					count--;
				}
				console.log("Should be adding a fallingCols.");
				fallingCols[fallingCols.length] = new fallingCol(i, j, tempNums);
			}
		}
	}
}

function drawFallingCols()
{
	for(var i = 0; i < fallingCols.length; i++)
	{
		for(var j = 0; j < fallingCols[i].nums.length; j++)
		{
			var x = (345 + (fallingCols[i].x * 60));
			var y = (40 + ((fallingCols[i].y - fallingCols[i].nums.length) *60) - (j * 60) + (fallingCols[i].startIt));
			ctx.fillStyle = "#000000";
			ctx.font = "30px Times New Roman";
			ctx.fillText(randNums[i][j].value, x, y);
		}
		fallingCols[i].startIt+=1;
		if(fallingCols[i].startIt == fallingCols[i].stopIt)
		{
			for(var j = 0; j < fallingCols[i].nums.length; j++)
			{
				randNums[fallingCols[i].x][fallingCols[i].y - j].value = fallingCols[i].nums[j];
				console.log("Index " + fallingCols[i].x + " and " + fallingCols[i].y - j + 
				" is given a value of: " + fallingCols[i].nums[j]);
				///fallingCols[i].y - fallingCols[i].nums.length
			}
		}
	}
}

function drawBoard()
{
	var grd1 = ctx.createLinearGradient(10, 160, 150, 0);
	grd1.addColorStop(0, "#0063EA");
	grd1.addColorStop(1, "#1477FF");
	ctx.fillStyle = grd1;
	ctx.beginPath();
	ctx.rect(0, 0, 800, 600);
	ctx.fill();
	
	ctx.fillStyle = "#DAF0FF"
	ctx.beginPath();
	ctx.rect(310, 10, 480, 480);
	ctx.fill();
	
	ctx.beginPath();
	ctx.rect(50, 150, 200, 50);
	ctx.stroke();
	
	ctx.beginPath();
	ctx.rect(50, 225, 200, 50);
	ctx.stroke();
	
	ctx.beginPath();
	ctx.rect(50, 475, 200, 50);
	ctx.stroke();

	ctx.fillStyle = "#FFF33F";
	ctx.font = "50px Times New Roman";
	ctx.fillText("Clever Jewl", 30, 75);
	ctx.beginPath();
	
	ctx.fillStyle = "#FFF33F";
	ctx.font = "50px Times New Roman";
	ctx.fillText("Pun", 115, 120);
	ctx.beginPath();
	
	ctx.fillStyle = "black"
	ctx.font = "30px Times New Roman";
	ctx.fillText("New Game", 75, 185);
	ctx.beginPath();
	
	ctx.fillStyle = "black"
	ctx.font = "30px Times New Roman";
	ctx.fillText("Options", 100, 260);
	ctx.beginPath();
	
	ctx.fillStyle = "black"
	ctx.font = "30px Times New Roman";
	ctx.fillText("Quit Game", 85, 510);
	ctx.beginPath();
	
	var grd = ctx.createRadialGradient(150,420,90,130,60,100);
	grd.addColorStop(0,"#1C8EFF");
	grd.addColorStop(1,"#88DAFF");

	ctx.fillStyle = grd;
	ctx.beginPath();
	ctx.arc(150, 375, 75, 0, 2 * Math.PI);
	ctx.fill();
	
	ctx.fillStyle = "black"
	ctx.font = "30px Times New Roman";
	ctx.fillText(score, 125, 380);
	
	ctx.beginPath();
	ctx.arc(150, 375, 75, 0, 2 * Math.PI);
	ctx.stroke();
}

function time()
{
		if(timeX < 100)
	{
		if(counter2 > 45)
		{
			counter2 = 1;
		}
		else if(counter2 > 30)
		{
			color = "#ff9100";
		}
		else if(counter2 > 15)
		{
			color = "#ff0044";
		}
		counter2++;
	}
	else if(counter > 360)
	{
		counter = 1;
	}
	else if(counter > 240)
	{
		color = "#47ff26";
	}
	else if(counter > 120)
	{
		color = "#af10ff";
	}
	else if(counter > 0)
	{
		color = "#ff8026";
	}
	counter++;
	ctx.fillStyle = color;
	ctx.beginPath();
	ctx.rect(320, 540, timeX, 20);
	ctx.fill();
	
	ctx.fillStyle = "#FFF33F";
	ctx.font = "30px Times New Roman";
	ctx.fillText("Time:", 320, 535);
	ctx.beginPath();
	
	ctx.beginPath();
	ctx.rect(320, 540, timeX, 20);
	ctx.stroke();
	

}

function drawCircles()
{
	for(var i =0;i<8;i++)
	{
			for(var j = 0;j<8;j++)
		{
			ctx.beginPath();
			ctx.arc((220 +(j*40)),(120 + (i*40)), 15, 0, 2 * Math.PI);
			ctx.stroke();
		}
	}
}

function draw()
{
if(fallingCols.length > 0)
{
	console.log("FallingCols size is: " + fallingCols.length);
}
		timeX-=.05;
		ctx.clearRect(0,0, 800, 600);
		drawBoard();
		drawGrid();
		time();
		collision();
		randArray();
		checkForMatches();
		console.log("We have exited check for matches");
		checkingForZeroes();
		console.log("We have exited check for zeroes");
		drawFallingCols();
	
}

setInterval(draw, 0);

</script>
</body>
</html>